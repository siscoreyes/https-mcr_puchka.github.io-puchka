<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESTADISTICO MCR PUCHKA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* (mantengo tu CSS tal cual) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(to bottom right, #eff6ff, #e0e7ff); min-height: 100vh; padding: 32px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); padding: 32px; }
        h1 { font-size: 36px; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .subtitle { color: #4b5563; margin-bottom: 32px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px; margin-bottom: 32px; }
        .upload-area { border: 2px dashed #93c5fd; border-radius: 8px; padding: 32px; text-align: center; background: #f0f9ff; transition: all 0.3s; cursor: pointer; }
        .upload-area:hover { background: #e0f2fe; }
        .upload-area input { display: none; }
        .upload-icon { width: 48px; height: 48px; color: #3b82f6; margin: 0 auto 12px; }
        .upload-area p { font-size: 18px; font-weight: 600; color: #374151; }
        .upload-area span { font-size: 14px; color: #6b7280; }
        .button-group { display: flex; flex-direction: column; gap: 12px; }
        button { width: 100%; font-weight: 600; padding: 12px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; font-size: 16px; }
        .btn-green { background: #22c55e; color: white; }
        .btn-green:hover { background: #16a34a; }
        .btn-indigo { background: #6366f1; color: white; }
        .btn-indigo:hover { background: #4f46e5; }
        .btn-red { background: #ef4444; color: white; }
        .btn-red:hover { background: #dc2626; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-blue:hover { background: #2563eb; }
        button:disabled { background: #d1d5db; cursor: not-allowed; }
        .info-box { padding: 16px; border-radius: 8px; margin-bottom: 24px; display: none; }
        .info-box.show { display: block; }
        .info-blue { background: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
        .info-error { background: #fef2f2; border: 1px solid #fecaca; }
        .info-error p { color: #991b1b; display: flex; gap: 12px; align-items: flex-start; }
        .info-success { background: #f0fdf4; border: 1px solid #bbf7d0; }
        .info-success p { color: #166534; display: flex; gap: 12px; align-items: center; }
        .filter-section { background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 20px; margin-bottom: 24px; display: none; }
        .filter-section.show { display: block; }
        .filter-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 16px; }
        .filter-item { display: flex; flex-direction: column; }
        .filter-item label { font-weight: 600; color: #1f2937; margin-bottom: 8px; font-size: 14px; }
        .filter-item select { padding: 10px; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 14px; background: white; cursor: pointer; transition: all 0.3s; }
        .filter-item select:hover { border-color: #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
        .filter-item select:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.5); }
        .filter-buttons { display: flex; gap: 12px; }
        .btn-small { padding: 10px 16px; font-size: 14px; flex: 1; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover { background: #4b5563; }
        .table-container { overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 24px; max-height: 400px; overflow-y: auto; }
        table { width: 100%; font-size: 14px; border-collapse: collapse; }
        thead { background: #f3f4f6; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 100; }
        th { padding: 14px; text-align: left; font-weight: 600; color: #374151; white-space: nowrap; background: #f3f4f6; }
        td { padding: 14px; color: #1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 285px; vertical-align: middle; }
        tbody tr { border-bottom: 1px solid #e5e7eb; transition: background-color 0.2s ease; }
        tbody tr:hover { background-color: #f9fafb; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 24px; background: #f0f4ff; border: 1px solid #c7d2fe; border-radius: 8px; }
        .stat-card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stat-label { font-size: 14px; color: #4b5563; font-weight: 600; margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: bold; }
        .stat-value.indigo { color: #4f46e5; }
        .stat-value.green { color: #22c55e; }
        .stat-value.blue { color: #3b82f6; }
        .stat-value.purple { color: #a855f7; }
        .stat-value.orange { color: #f97316; }
        .section-title { font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 16px; }
        .records-info { color: #4b5563; margin-bottom: 16px; }
        .rank-number { display: inline-block; min-width: 32px; height: 32px; background: #4f46e5; color: white; border-radius: 50%; text-align: center; line-height: 32px; font-weight: bold; margin-right: 8px; }
        .frequency-bar { display: inline-block; background: linear-gradient(90deg, #3b82f6, #2563eb); color: white; padding: 4px 12px; border-radius: 4px; font-weight: bold; }
        .production-section { background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 20px; margin-bottom: 24px; display: none; }
        .production-section.show { display: block; }
        .production-section h3 { margin-bottom: 16px; color: #92400e; font-size: 18px; }
        .production-section p { color: #b45309; margin-bottom: 16px; }
        .production-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ESTAD√çSTICO MCR PUCHKA</h1> <!-- se a√±adi√≥ t√≠tulo visible -->
            <p class="subtitle">ESTADISTICO MCR PUCHKA</p>
            
            <div class="grid">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <svg class="upload-icon" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 17a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1v-2zm6-5a1 1 0 11-2 0 1 1 0 012 0z"></path>
                        <path d="M3 5a2 2 0 012-2h6a2 2 0 012 2v4a1 1 0 11-2 0V5H5v12h4v-2a1 1 0 112 0v2h1a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v4a1 1 0 112 0V5z"></path>
                    </svg>
                    <p>CARGAR EL ARCHIVO EXCEL </p>
                    <span> </span>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
                </div>
                
                <div class="button-group">
                    <button class="btn-indigo" id="downloadBtn" onclick="downloadData()" disabled>Descargar Archivo</button>
                    <button class="btn-red" id="clearBtn" onclick="clearData()" disabled>Limpiar Todo</button>
                </div>
            </div>
            
            <div id="fileNameBox" class="info-box info-blue">
                <p><strong>üìÑ Archivo de EXCEL:</strong> <span id="fileName"></span></p>
            </div>
            
            <div id="errorBox" class="info-box info-error"></div>
            <div id="successBox" class="info-box info-success"></div>
            
            <div id="productionFileBox" class="info-box info-blue" style="display: none;">
                <p><strong>üìã Archivo de Producciones:</strong> <span id="productionFileNameDisplay"></span></p>
            </div>
            
            <div id="filterSection" class="filter-section" style="display: none;">
                <h3 style="margin-bottom: 16px; color: #1f2937;">Filtrar Datos</h3>
                <div class="filter-group">
                    <div class="filter-item">
                        <label for="establishmentFilter">Establecimiento</label>
                        <select id="establishmentFilter" onchange="applyFiltersAuto()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label for="personalFilter">Personal</label>
                        <select id="personalFilter" onchange="applyFiltersAuto()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                </div>
                <div class="filter-buttons">
                    <button class="btn-secondary btn-small" onclick="resetFilters()">Limpiar Filtros</button>
                </div>
            </div>
            
            <div id="productionSection" class="production-section">
                <h3>üìä Cargar Archivo Excel de Producciones</h3>
                <p> </p>
                <div class="production-buttons">
                    <button class="btn-blue btn-small" onclick="document.getElementById('productionFileInput').click()" style="flex: 1; min-width: 200px;">
                        üìÅ Cargar Archivo de Producciones
                    </button>
                    <input type="file" id="productionFileInput" accept=".xlsx,.xls,.csv" onchange="handleProductionFileUpload(event)" style="display: none;">
                    <button class="btn-indigo btn-small" onclick="compareProductions()" id="compareBtn" disabled style="flex: 1; min-width: 200px;">
                        ‚öñÔ∏è Generado Reporte
                    </button>
                </div>
                <p id="productionFileName" style="margin-top: 12px; font-size: 14px; color: #92400e; font-weight: 500;"></p>
            </div>
            
            <div id="productionReportSection" style="display: none; margin-top: 32px;">
                <h2 class="section-title">üìä Reporte de Reporte de Personal</h2>
                <p style="color: #4b5563; margin-bottom: 16px;">Comparaci√≥n de las producciones del personal de salud</p>
                <div class="table-container">
                    <table id="productionTable">
                        <thead id="productionHead"></thead>
                        <tbody id="productionBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div id="previewSection" style="display: none;">
                <h2 class="section-title">Vista Previa de Datos Cargados</h2>
                <p class="records-info">Total de registros: <span id="totalRecords">0</span></p>
                
                <div class="stats-grid" id="statsGrid"></div>
                
                <div style="margin-top: 32px;">
                    <button class="btn-blue" onclick="generateFrequencyReport()" style="margin-bottom: 16px; display: none;">üìä Generar Reporte de Frecuencia (Top 10)</button>
                    <button class="btn-blue" onclick="generateReportByProfessional();" style="margin-bottom: 16px; margin-left: 8px; display: none;">üë®‚Äç‚öïÔ∏è Reporte de Producciones</button>
                    <button class="btn-blue" id="printBtn" onclick="downloadReport()" disabled style="margin-bottom: 16px; margin-left: 8px; background: #059669;">‚¨áÔ∏è Descargar Reporte</button>
                </div>
                
                <div id="frequencyReportSection" style="display: none; margin-top: 32px;">
                    <h2 class="section-title">Top 10 Descripciones de √çtems M√°s Frecuentes</h2>
                    <div class="table-container">
                        <table id="frequencyTable">
                            <thead id="frequencyHead"></thead>
                            <tbody id="frequencyBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div id="reportSection2" style="display: none; margin-top: 32px;">
                    <h2 class="section-title">Resumen de Producciones por Profesional y Fechas</h2>
                    <div class="table-container">
                        <table id="reportTable2">
                            <thead id="reportHead2"></thead>
                            <tbody id="reportBody2"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let allHeaders = [];
        let currentReport = null;
        let productionData = [];
        let db = null;

        // Inicializar IndexedDB al cargar
        window.addEventListener('DOMContentLoaded', () => {
            initDB();
        });

        function initDB() {
            const request = indexedDB.open('MedicalDataDB', 1);
            
            request.onerror = () => {
                console.log('Error al abrir DB');
            };
            
            request.onupgradeneeded = (e) => {
                const dbUp = e.target.result;
                if (!dbUp.objectStoreNames.contains('medicalData')) {
                    dbUp.createObjectStore('medicalData', { keyPath: 'id' });
                }
            };
            
            request.onsuccess = (e) => {
                db = e.target.result;
                loadFromStorage();
            };
        }

        function saveToStorage() {
            if (!db) return;
            
            const dataToSave = {
                id: 1,
                allData,
                allHeaders,
                productionData,
                filteredData
            };
            
            const transaction = db.transaction(['medicalData'], 'readwrite');
            const store = transaction.objectStore('medicalData');
            store.put(dataToSave);
        }

        function loadFromStorage() {
            if (!db) return;
            
            const transaction = db.transaction(['medicalData'], 'readonly');
            const store = transaction.objectStore('medicalData');
            const request = store.get(1);
            
            request.onsuccess = (e) => {
                const data = e.target.result;
                if (data) {
                    allData = data.allData || [];
                    allHeaders = data.allHeaders || [];
                    productionData = data.productionData || [];
                    filteredData = data.filteredData || [...allData];
                    
                    if (allData.length > 0) {
                        document.getElementById('fileNameBox').classList.add('show');
                        document.getElementById('fileName').textContent = 'Datos cargados (persistentes)';
                        populateFilters();
                        displayData();
                        document.getElementById('downloadBtn').disabled = false;
                        document.getElementById('clearBtn').disabled = false;
                        document.getElementById('filterSection').classList.add('show');
                        document.getElementById('productionSection').classList.add('show');
                        document.getElementById('fileInput').disabled = true;
                    }
                    
                    if (productionData.length > 0) {
                        // mostrar nombre de archivo de producciones si se guard√≥ en storage (si no se guard√≥ el nombre, mostramos la cuenta)
                        document.getElementById('productionFileName').textContent = `‚úì Archivo de producci√≥n cargado (${productionData.length} registros)`;
                        document.getElementById('productionFileBox').style.display = 'block';
                        document.getElementById('productionFileNameDisplay').textContent = `Registros: ${productionData.length}`;
                        document.getElementById('compareBtn').disabled = false;
                    }
                }
            };
        }

        function showMessage(type, message) {
            const errorBox = document.getElementById('errorBox');
            const successBox = document.getElementById('successBox');
            
            if (type === 'error') {
                errorBox.innerHTML = `<p>‚ùå ${message}</p>`;
                errorBox.classList.add('show');
                successBox.classList.remove('show');
            } else if (type === 'success') {
                successBox.innerHTML = `<p>‚úì ${message}</p>`;
                successBox.classList.add('show');
                errorBox.classList.remove('show');
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar que NO sea un archivo de producciones
            const fileName = (file.name || '').toLowerCase();
            if (fileName.includes('producciones') || fileName.includes('produccion')) {
                showMessage('error', 'Este archivo parece ser de Producciones. Usa el bot√≥n "Cargar Archivo de Producci√≥n" para cargarlo.');
                document.getElementById('fileInput').value = '';
                return;
            }

            // Si ya hay datos cargados, mostrar advertencia
            if (allData.length > 0) {
                showMessage('error', 'Ya hay datos cargados. Usa "Limpiar Todo" para cargar un nuevo archivo.');
                document.getElementById('fileInput').value = '';
                return;
            }

            document.getElementById('fileNameBox').classList.add('show');
            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', defval: '' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '', blankrows: false });

                    if (jsonData.length === 0) {
                        showMessage('error', 'El archivo Excel est√° vac√≠o');
                        return;
                    }

                    const range = worksheet['!ref'] ? XLSX.utils.decode_range(worksheet['!ref']) : null;
                    const headers = [];
                    
                    if (range) {
                        for (let col = range.s.c; col <= range.e.c; col++) {
                            const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                            const cell = worksheet[cellAddress];
                            if (cell) {
                                headers.push(cell.v);
                            }
                        }
                    }

                    allHeaders = headers.length > 0 ? headers : Object.keys(jsonData[0] || {});
                    allData = jsonData;
                    filteredData = [...allData];

                    showMessage('success', `Archivo de citas cargado correctamente. ${jsonData.length} registros encontrados.`);
                    saveToStorage();
                    populateFilters();
                    displayData();

                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('clearBtn').disabled = false;
                    document.getElementById('filterSection').classList.add('show');
                    document.getElementById('productionSection').classList.add('show');
                    
                    // Deshabilitar el bot√≥n de cargar despu√©s de subir
                    document.getElementById('fileInput').disabled = true;
                    
                    // Resetear el archivo de producciones al cargar nuevos datos de citas
                    productionData = [];
                    document.getElementById('productionFileInput').value = '';
                    document.getElementById('productionFileName').textContent = '';
                    document.getElementById('productionFileBox').style.display = 'none';
                    document.getElementById('productionFileNameDisplay').textContent = '';
                    document.getElementById('compareBtn').disabled = true;
                } catch (err) {
                    showMessage('error', 'Error al procesar el archivo: ' + (err && err.message ? err.message : String(err)));
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleProductionFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar que S√ç sea un archivo de producciones
            const fileName = (file.name || '').toLowerCase();
            if (!fileName.includes('producciones') && !fileName.includes('produccion')) {
                showMessage('error', 'Este archivo no parece ser de Producciones. El archivo debe incluir "producciones" o "produccion" en su nombre.');
                document.getElementById('productionFileInput').value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', defval: '' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '', blankrows: false });

                    if (jsonData.length === 0) {
                        showMessage('error', 'El archivo de producci√≥n est√° vac√≠o');
                        return;
                    }

                    productionData = jsonData;
                    document.getElementById('productionFileName').textContent = `‚úì Archivo de producci√≥n cargado: ${file.name} (${jsonData.length} registros)`;
                    document.getElementById('productionFileBox').style.display = 'block';
                    document.getElementById('productionFileNameDisplay').textContent = `${file.name} ‚Äî ${jsonData.length} registros`;
                    document.getElementById('compareBtn').disabled = false;
                    showMessage('success', `Archivo de producci√≥n cargado correctamente. ${jsonData.length} registros encontrados.`);
                    saveToStorage();
                } catch (err) {
                    showMessage('error', 'Error al procesar el archivo de producci√≥n: ' + (err && err.message ? err.message : String(err)));
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function compareProductions() {
            if (productionData.length === 0 || filteredData.length === 0) {
                showMessage('error', 'Debes cargar ambos archivos para comparar');
                return;
            }

            // CITAS: Contar Id_Paciente √∫nicos por d√≠a
            const medicalProductions = {};
            filteredData.forEach(row => {
                const personal = row.Nombres_Personal || 'SIN NOMBRE';
                const establecimiento = row.Nombre_Establecimiento || 'SIN ESTABLECIMIENTO';
                const profesion = row.Descripcion_Profesion || 'SIN PROFESI√ìN';
                const dia = row.Dia || 'SIN D√çA';
                const idPaciente = row.Id_Paciente || row.Numero_Documento_Paciente || 'SIN PACIENTE';
                
                const key = establecimiento + '|' + personal + '|' + profesion + '|' + dia;
                
                if (!medicalProductions[key]) {
                    medicalProductions[key] = {
                        establecimiento,
                        personal,
                        profesion,
                        dia,
                        pacientes: new Set()
                    };
                }
                medicalProductions[key].pacientes.add(String(idPaciente).trim());
            });

            // PRODUCCIONES: Contar Id_Paciente √∫nicos por d√≠a
            const registeredProductions = {};
            productionData.forEach(row => {
                const personal = row.Nombres_Personal || 'SIN NOMBRE';
                const establecimiento = row.Nombre_Establecimiento || 'SIN ESTABLECIMIENTO';
                const profesion = row.Descripcion_Profesion || 'SIN PROFESI√ìN';
                const dia = row.Dia || 'SIN D√çA';
                const idPaciente = row.Id_Paciente || row.Numero_Documento_Paciente || 'SIN PACIENTE';
                
                const key = establecimiento + '|' + personal + '|' + profesion + '|' + dia;
                
                if (!registeredProductions[key]) {
                    registeredProductions[key] = {
                        establecimiento,
                        personal,
                        profesion,
                        dia,
                        pacientes: new Set()
                    };
                }
                registeredProductions[key].pacientes.add(String(idPaciente).trim());
            });

            const allPersonal = new Set([
                ...Object.keys(medicalProductions),
                ...Object.keys(registeredProductions)
            ]);

            const comparisonData = Array.from(allPersonal).map(key => {
                const medical = medicalProductions[key];
                const registered = registeredProductions[key];
                
                const citasCount = medical ? medical.pacientes.size : 0;
                const produccionesCount = registered ? registered.pacientes.size : 0;
                
                return {
                    establecimiento: medical?.establecimiento || registered?.establecimiento || '',
                    personal: medical?.personal || registered?.personal || '',
                    profesion: medical?.profesion || registered?.profesion || '',
                    dia: medical?.dia || registered?.dia || '',
                    citasAtendidas: citasCount,
                    produccionesRegistradas: produccionesCount,
                    diferencia: produccionesCount - citasCount
                };
            }).sort((a, b) => {
                if (a.establecimiento !== b.establecimiento) return (a.establecimiento || '').localeCompare(b.establecimiento || '');
                if (a.personal !== b.personal) return (a.personal || '').localeCompare(b.personal || '');
                if (a.profesion !== b.profesion) return (a.profesion || '').localeCompare(b.profesion || '');
                // ordenar d√≠a como n√∫mero si es posible
                const da = parseInt(a.dia) || 0;
                const db = parseInt(b.dia) || 0;
                return da - db;
            });

            displayProductionComparison(comparisonData);
            currentReport = 'production';
            document.getElementById('printBtn').disabled = false;
            showMessage('success', `Comparaci√≥n realizada: ${comparisonData.length} registros analizados`);
        }

        function displayProductionComparison(data) {
            const groupedData = {};
            
            data.forEach(item => {
                const groupKey = item.establecimiento + '|' + item.personal + '|' + item.profesion;
                if (!groupedData[groupKey]) {
                    groupedData[groupKey] = {
                        establecimiento: item.establecimiento,
                        personal: item.personal,
                        profesion: item.profesion,
                        totalProductions: 0,
                        dias: {}
                    };
                }
                // ahora sumamos produccionesRegistradas (y no citasAtendidas) para el total de producciones
                groupedData[groupKey].totalProductions += item.produccionesRegistradas || 0;
                groupedData[groupKey].dias[item.dia] = item;
            });

            const allDias = new Set();
            data.forEach(item => {
                allDias.add(item.dia);
            });
            // ordenar d√≠as num√©ricamente si posible
            const sortedDias = Array.from(allDias).sort((a, b) => (parseInt(a) || 0) - (parseInt(b) || 0));

            const productionHead = document.getElementById('productionHead');
            let headerHTML = `
                <tr style="background: #f3f4f6;">
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Establecimiento</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Personal</th>
                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Profesi√≥n</th>
                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; min-width: 100px;">Total Producciones</th>
            `;
            
            sortedDias.forEach(dia => {
                headerHTML += `<th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; min-width: 80px;">D√≠a ${dia}</th>`;
            });
            headerHTML += `</tr>`;
            productionHead.innerHTML = headerHTML;

            const productionBody = document.getElementById('productionBody');
            productionBody.innerHTML = Object.values(groupedData).map(group => {
                let rowHTML = `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; color: #1f2937;">${group.establecimiento}</td>
                        <td style="padding: 12px; color: #1f2937;">${group.personal}</td>
                        <td style="padding: 12px; color: #1f2937;">${group.profesion}</td>
                        <td style="padding: 12px; text-align: center; font-weight: 600; color: white; background: #3b82f6;">${group.totalProductions}</td>
                `;
                
                sortedDias.forEach(dia => {
                    const item = group.dias[dia];
                    if (item && (item.produccionesRegistradas > 0 || item.citasAtendidas > 0)) {
                        // mostramos produccionesRegistradas, y si no existe mostramos citasAtendidas para dar contexto
                        const val = item.produccionesRegistradas > 0 ? item.produccionesRegistradas : item.citasAtendidas;
                        rowHTML += `<td style="padding: 12px; text-align: center; background: #dcfce7; color: #15803d; font-weight: bold; min-width: 80px;">${val}</td>`;
                    } else {
                        rowHTML += `<td style="padding: 12px; text-align: center; background: #fee2e2; color: #991b1b; font-weight: bold; min-width: 80px;"> ‚úó</td>`;
                    }
                });
                
                rowHTML += `</tr>`;
                return rowHTML;
            }).join('');

            document.getElementById('productionReportSection').style.display = 'block';
            currentReport = 'production';
            document.getElementById('printBtn').disabled = false;
        }

        function populateFilters() {
            const establishments = [...new Set(allData.map(row => row.Nombre_Establecimiento).filter(Boolean))].sort();
            const personnel = [...new Set(allData.map(row => row.Nombres_Personal).filter(Boolean))].sort();

            const estSelect = document.getElementById('establishmentFilter');
            const perSelect = document.getElementById('personalFilter');

            estSelect.innerHTML = '<option value="">Todos</option>';
            establishments.forEach(est => {
                const option = document.createElement('option');
                option.value = est;
                option.textContent = est;
                estSelect.appendChild(option);
            });

            perSelect.innerHTML = '<option value="">Todos</option>';
            personnel.forEach(per => {
                const option = document.createElement('option');
                option.value = per;
                option.textContent = per;
                perSelect.appendChild(option);
            });
        }

        function applyFiltersAuto() {
            const establishment = document.getElementById('establishmentFilter').value;
            const personal = document.getElementById('personalFilter').value;

            filteredData = allData.filter(row => {
                let match = true;
                if (establishment) match = match && row.Nombre_Establecimiento === establishment;
                if (personal) match = match && row.Nombres_Personal === personal;
                return match;
            });

            displayData();
            showMessage('success', `‚úì Filtros aplicados. ${filteredData.length} registros encontrados.`);
        }

        function applyFilters() {
            applyFiltersAuto();
        }

        function resetFilters() {
            document.getElementById('establishmentFilter').value = '';
            document.getElementById('personalFilter').value = '';
            filteredData = [...allData];
            displayData();
            showMessage('success', 'Filtros eliminados. Mostrando todos los registros.');
        }

        function displayData() {
            document.getElementById('previewSection').style.display = 'block';
            document.getElementById('productionSection').classList.add('show');
            document.getElementById('totalRecords').textContent = filteredData.length;

            const professionals = new Set(filteredData.map(row => row.Nombres_Personal).filter(Boolean)).size;
            const establishments = new Set(filteredData.map(row => row.Nombre_Establecimiento).filter(Boolean)).size;
            const patients = new Set(filteredData.map(row => row.Numero_Documento_Paciente).filter(Boolean)).size;
            const services = new Set(filteredData.map(row => row.Descripcion_Ups).filter(Boolean)).size;

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total de Registros</div>
                    <div class="stat-value indigo">${filteredData.length.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Profesionales</div>
                    <div class="stat-value green">${professionals}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Establecimientos</div>
                    <div class="stat-value blue">${establishments}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pacientes</div>
                    <div class="stat-value purple">${patients}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Servicios</div>
                    <div class="stat-value orange">${services}</div>
                </div>
            `;
        }

        function generateFrequencyReport() {
            if (filteredData.length === 0) return;

            const frequencyMap = {};
            filteredData.forEach(row => {
                const item = row.Descripcion_Item || 'SIN DESCRIPCI√ìN';
                frequencyMap[item] = (frequencyMap[item] || 0) + 1;
            });

            const sortedItems = Object.entries(frequencyMap)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const maxFrequency = sortedItems[0]?.[1] || 1;

            const frequencyHead = document.getElementById('frequencyHead');
            frequencyHead.innerHTML = '<tr style="background: #f3f4f6;"><th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; width: 50px;">Ranking</th><th style="padding: 12px; text-align: left; font-weight: 600; color: #374151;">Descripci√≥n del √çtem</th><th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 120px;">Frecuencia</th><th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; width: 150px;">Progreso</th></tr>';

            const frequencyBody = document.getElementById('frequencyBody');
            frequencyBody.innerHTML = sortedItems.map((item, idx) => {
                const percentage = ((item[1] / maxFrequency) * 100).toFixed(1);
                
                let rankColor = '#4f46e5';
                let barColor = 'linear-gradient(90deg, #3b82f6, #2563eb)';
                let barBgColor = '#dbeafe';
                
                if (idx === 0) {
                    rankColor = '#dc2626';
                    barColor = 'linear-gradient(90deg, #ef4444, #dc2626)';
                    barBgColor = '#fee2e2';
                } else if (idx === 1) {
                    rankColor = '#22c55e';
                    barColor = 'linear-gradient(90deg, #22c55e, #16a34a)';
                    barBgColor = '#dcfce7';
                } else if (idx === 2) {
                    rankColor = '#eab308';
                    barColor = 'linear-gradient(90deg, #eab308, #ca8a04)';
                    barBgColor = '#fef3c7';
                }
                
                return `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 12px; text-align: center;">
                            <span class="rank-number" style="background: ${rankColor};">${idx + 1}</span>
                        </td>
                        <td style="padding: 12px; color: #1f2937; max-width: 400px; word-wrap: break-word; white-space: normal;">
                            ${item[0]}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <span class="frequency-bar" style="background: ${barColor};">${item[1]} casos</span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="background: ${barBgColor}; border-radius: 4px; height: 24px; position: relative; overflow: hidden;">
                                <div style="background: ${barColor}; height: 100%; width: ${percentage}%; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: bold;">
                                    ${percentage}%
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            document.getElementById('frequencyReportSection').style.display = 'block';
            document.getElementById('printBtn').disabled = false;
            currentReport = 'frequency';
            showMessage('success', `Reporte generado: Top 10 de ${Object.keys(frequencyMap).length} √≠tems √∫nicos`);
        }

        function generateReportByProfessional() {
            if (filteredData.length === 0) return;

            const pivotData = {};
            
            filteredData.forEach(row => {
                const establecimiento = row.Nombre_Establecimiento || 'SIN ESTABLECIMIENTO';
                const personal = row.Nombres_Personal || 'SIN NOMBRE';
                const dia = row.Dia || '0';
                const cantidad = parseInt(row.Cantidad || row.cantidad || 1) || 1;
                
                const estKey = establecimiento;
                const perKey = personal;
                const diaKey = String(dia);
                
                if (!pivotData[estKey]) {
                    pivotData[estKey] = {};
                }
                if (!pivotData[estKey][perKey]) {
                    pivotData[estKey][perKey] = {};
                }
                if (!pivotData[estKey][perKey][diaKey]) {
                    pivotData[estKey][perKey][diaKey] = 0;
                }
                
                pivotData[estKey][perKey][diaKey] += cantidad;
            });

            const allDays = new Set();
            Object.values(pivotData).forEach(est => {
                Object.values(est).forEach(per => {
                    Object.keys(per).forEach(dia => allDays.add(parseInt(dia) || 0));
                });
            });
            const sortedDays = Array.from(allDays).sort((a, b) => a - b);

            const reportHead2 = document.getElementById('reportHead2');
            let headerHTML = '<tr style="background: #f3f4f6;"><th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; min-width: 200px;">Establecimiento</th><th style="padding: 12px; text-align: left; font-weight: 600; color: #374151; min-width: 150px;">Personal</th><th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; min-width: 80px;">Total</th>';
            
            sortedDays.forEach(dia => {
                headerHTML += `<th style="padding: 12px; text-align: center; font-weight: 600; color: #374151; min-width: 60px;">${dia}</th>`;
            });
            headerHTML += '</tr>';
            reportHead2.innerHTML = headerHTML;

            const reportBody2 = document.getElementById('reportBody2');
            let bodyHTML = '';
            let totalByDay = {};
            sortedDays.forEach(d => totalByDay[d] = 0);
            let grandTotal = 0;

            Object.entries(pivotData).forEach(([est, personas]) => {
                Object.entries(personas).forEach(([per, dias], idx) => {
                    let perTotal = Object.values(dias).reduce((a, b) => a + b, 0);
                    grandTotal += perTotal;
                    
                    let rowHTML = '<tr style="border-bottom: 1px solid #e5e7eb;">';
                    
                    if (idx === 0) {
                        rowHTML += `<td style="padding: 12px; color: #1f2937; font-weight: bold; background: #f0f9ff; border-right: 2px solid #bfdbfe;">${est}</td>`;
                    } else {
                        rowHTML += `<td style="padding: 12px; color: #1f2937; background: #f0f9ff; border-right: 2px solid #bfdbfe;"></td>`;
                    }
                    
                    rowHTML += `<td style="padding: 12px; color: #1f2937;">${per}</td>`;
                    rowHTML += `<td style="padding: 12px; text-align: center; font-weight: 600; color: white; background: #3b82f6;">${perTotal}</td>`;
                    
                    sortedDays.forEach(dia => {
                        const count = dias[String(dia)] || 0;
                        totalByDay[dia] += count;
                        
                        if (count > 0) {
                            rowHTML += `<td style="padding: 12px; text-align: center; background: #dcfce7; color: #15803d; font-weight: bold;"> ${count}</td>`;
                        } else {
                            rowHTML += `<td style="padding: 12px; text-align: center; background: #fee2e2; color: #991b1b; font-weight: bold;"> No</td>`;
                        }
                    });
                    
                    rowHTML += '</tr>';
                    bodyHTML += rowHTML;
                });
            });

            let totalRow = '<tr style="border-top: 2px solid #000; background: #f3f4f6; font-weight: bold;">';
            totalRow += `<td colspan="2" style="padding: 12px; text-align: right; color: #1f2937; font-weight: bold;">Total general</td>`;
            totalRow += `<td style="padding: 12px; text-align: center; font-weight: 600; color: white; background: #1f2937;">${grandTotal}</td>`;
            
            sortedDays.forEach(dia => {
                totalRow += `<td style="padding: 12px; text-align: center; font-weight: bold; background: #e5e7eb; color: #1f2937;">${totalByDay[dia]}</td>`;
            });
            
            totalRow += '</tr>';
            bodyHTML += totalRow;

            reportBody2.innerHTML = bodyHTML;

            document.getElementById('reportSection2').style.display = 'block';
            document.getElementById('printBtn').disabled = false;
            currentReport = 'professional';
            showMessage('success', `Reporte generado: Total de ${grandTotal} citas`);
        }

        function printReport() {
            const { date, time } = getDateTime();
            const printWindow = window.open('', '', 'height=600,width=1200');
            
            if (!printWindow) {
                showMessage('error', 'No se pudo abrir la ventana de impresi√≥n. Verifica los permisos del navegador.');
                return;
            }
            
            let reportTable = '';
            let title = '';
            
            if (currentReport === 'frequency') {
                reportTable = document.getElementById('frequencyTable').outerHTML;
                title = 'Top 10 Descripciones de √çtems M√°s Frecuentes';
            } else if (currentReport === 'professional') {
                reportTable = document.getElementById('reportTable2').outerHTML;
                title = 'Resumen de Producciones por Profesional y D√≠as';
            } else if (currentReport === 'production') {
                reportTable = document.getElementById('productionTable').outerHTML;
                title = 'Comparativa de Producciones por Personal';
            }
            
            const html = `
                <html>
                <head>
                    <title>Reporte</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1 { text-align: center; color: #1f2937; }
                        .header { text-align: right; margin-bottom: 20px; font-size: 12px; }
                        table { width: 100%; border-collapse: collapse; }
                        th { background: #f3f4f6; padding: 12px; text-align: left; font-weight: 600; border: 1px solid #d1d5db; }
                        td { padding: 12px; border: 1px solid #d1d5db; }
                        tr:nth-child(even) { background: #f9fafb; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="header">
                        Fecha: ${date}<br>
                        Hora: ${time}
                    </div>
                    ${reportTable}
                </body>
                </html>
            `;
            
            printWindow.document.write(html);
            printWindow.document.close();
            
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }

        function downloadReport() {
            const { date, time } = getDateTime();
            let tableHtml = '';
            let title = '';
            
            if (currentReport === 'frequency') {
                title = 'Top 10 Descripciones de √çtems M√°s Frecuentes';
                tableHtml = document.getElementById('frequencyTable').outerHTML;
            } else if (currentReport === 'professional') {
                title = 'Resumen de Producciones por Profesional y D√≠as';
                tableHtml = document.getElementById('reportTable2').outerHTML;
            } else if (currentReport === 'production') {
                title = 'Comparativa de Producciones por Personal';
                tableHtml = document.getElementById('productionTable').outerHTML;
            }
            
            const html = `
                <html xmlns:x="urn:schemas-microsoft-com:office:excel">
                <head>
                    <meta charset="UTF-8">
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; }
                        h1 { text-align: center; color: #1f2937; font-size: 18px; margin: 20px 0 5px; }
                        .header { text-align: center; color: #666; font-size: 12px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        thead { background-color: #3b82f6; color: white; }
                        thead th { padding: 12px; text-align: left; font-weight: bold; border: 1px solid #000; background-color: #3b82f6; color: white; }
                        tbody td { padding: 12px; border: 1px solid #e5e7eb; text-align: left; }
                        tbody tr:nth-child(even) { background-color: #f9fafb; }
                        tbody tr:nth-child(odd) { background-color: #ffffff; }
                    </style>
                </head>
                <body>
                    <h1>${title}</h1>
                    <div class="header">
                        Fecha: ${date} | Hora: ${time}
                    </div>
                    ${tableHtml}
                </body>
                </html>
            `;
            
            const blob = new Blob([html], { type: 'application/vnd.ms-excel;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `reporte_${title.replace(/\s+/g, '_')}_${new Date().getTime()}.xls`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('success', '‚úì Reporte descargado en Excel con todos los estilos');
        }

        function getDateTime() {
            const now = new Date();
            const date = now.getDate().toString().padStart(2, '0') + '/' + 
                        (now.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                        now.getFullYear();
            const time = now.getHours().toString().padStart(2, '0') + ':' + 
                        now.getMinutes().toString().padStart(2, '0') + ':' + 
                        now.getSeconds().toString().padStart(2, '0');
            return { date, time };
        }

        function downloadTemplate() {
            const templateFields = ['Id_Cita', 'Fecha_Atencion', 'Descripcion_Item', 'Nombre_Establecimiento', 
                                  'Nombres_Personal', 'Descripcion_Profesion', 'Apellido_Paterno_Paciente',
                                  'Apellido_Materno_Paciente', 'Nombres_Paciente', 'Numero_Documento_Paciente', 'Dia'];
            const ws = XLSX.utils.json_to_sheet([templateFields.reduce((obj, field) => ({...obj, [field]: ''}), {})]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Plantilla');
            XLSX.writeFile(wb, 'plantilla_datos_medicos.xlsx');
            showMessage('success', '‚úì Plantilla descargada');
        }

        function downloadData() {
            if (filteredData.length === 0) return;

            const dateColumns = new Set();
            allHeaders.forEach(header => {
                if (!header) return;
                const lh = String(header).toLowerCase();
                if (lh.includes('fecha') || lh.includes('date') || lh.includes('dia')) {
                    dateColumns.add(header);
                }
            });

            const completeData = filteredData.map(row => {
                const completeRow = {};
                allHeaders.forEach(header => {
                    let value = row[header] !== undefined ? row[header] : '';
                    if (dateColumns.has(header) && value) {
                        value = formatDateValue(value);
                    }
                    completeRow[header] = value;
                });
                return completeRow;
            });

            const ws = XLSX.utils.json_to_sheet(completeData);
            
            allHeaders.forEach((header, idx) => {
                if (dateColumns.has(header)) {
                    const col = XLSX.utils.encode_col(idx);
                    for (let row = 2; row <= completeData.length + 1; row++) {
                        const cellAddress = col + row;
                        if (ws[cellAddress]) {
                            ws[cellAddress].z = 'dd/mm/yyyy';
                        }
                    }
                }
            });

            const colWidths = allHeaders.map(h => ({ wch: 18 }));
            ws['!cols'] = colWidths;

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Datos');
            XLSX.writeFile(wb, `datos_exportados_${new Date().getTime()}.xlsx`);
            showMessage('success', '‚úì Datos descargados con formato de fecha preservado');
        }

        function formatDateValue(value) {
            if (!value) return '';
            if (typeof value === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(value)) {
                return value;
            }
            if (typeof value === 'number') {
                const date = new Date((value - 25569) * 86400 * 1000);
                return date.getDate().toString().padStart(2, '0') + '/' + 
                       (date.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                       date.getFullYear();
            }
            if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}/.test(value)) {
                const date = new Date(value);
                return date.getDate().toString().padStart(2, '0') + '/' + 
                       (date.getMonth() + 1).toString().padStart(2, '0') + '/' + 
                       date.getFullYear();
            }
            return String(value);
        }

        function clearData() {
            allData = [];
            filteredData = [];
            productionData = [];
            allHeaders = [];
            currentReport = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('fileInput').disabled = false;
            const prodInput = document.getElementById('productionFileInput');
            if (prodInput) prodInput.value = '';
            document.getElementById('fileNameBox').classList.remove('show');
            document.getElementById('productionFileBox').style.display = 'none';
            document.getElementById('errorBox').classList.remove('show');
            document.getElementById('successBox').classList.remove('show');
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('productionSection').classList.remove('show');
            document.getElementById('frequencyReportSection').style.display = 'none';
            document.getElementById('reportSection2').style.display = 'none';
            document.getElementById('productionReportSection').style.display = 'none';
            document.getElementById('filterSection').classList.remove('show');
            document.getElementById('downloadBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
            document.getElementById('printBtn').disabled = true;
            document.getElementById('compareBtn').disabled = true;
            document.getElementById('productionFileName').textContent = '';
            document.getElementById('productionFileNameDisplay').textContent = '';
            
            if (db) {
                const transaction = db.transaction(['medicalData'], 'readwrite');
                const store = transaction.objectStore('medicalData');
                store.clear();
            }
            
            showMessage('success', '‚úì Todos los datos han sido eliminados');
        }
    </script>
</body>
</html>
